from SocketServer import ThreadingUDPServer, DatagramRequestHandler
from src.KThread  import *



infected_hosts_list = []


class Malware_request_handler( DatagramRequestHandler ):
    ''' Class of Malware request handler.

    TODO
    '''
    def handle(self):
        '''Handle requests to Malware Center server.
        '''
        data = self.rfile.read()
        if data not in infected_hosts_list:
            print("new worm instance " + str(data))
            infected_hosts_list.append(data)


def start_malware_center(ip="localhost", port=56565):
    '''Starts Malware Center.

    Args:
        ip: IP address of Malware Center server.
        port: port of Malware Center server.
    '''
    server = ThreadingUDPServer((ip, port), Malware_request_handler)
    server.allow_reuse_address = True
    print("Malware Center started")
    print("IP: " + ip)
    print("PORT: " + str(port))
    #print("new worm instance h3-eth0:77.77.77.77")
    server.serve_forever()


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == '--help':
        print 'args: (malware_center_ip, malware_center_port)'
        exit(-1)

    if len(sys.argv) != 3:
        print('Not enough args')
        exit(-123)

    malware_center_ip = sys.argv[1]
    malware_center_port = int(sys.argv[2])

    server_thread = KThread(target=start_malware_center, args=(malware_center_ip, malware_center_port))
#    server_thread.daemon = True
    server_thread.start()
#    server_thread.kill()








